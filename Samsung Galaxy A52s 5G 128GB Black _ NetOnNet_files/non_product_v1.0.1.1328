/* Minification failed. Returning unminified contents.
(2815,68-69): run-time error JS1014: Invalid character: `
(2815,70-71): run-time error JS1004: Expected ';': {
(2815,121-122): run-time error JS1014: Invalid character: `
(2820,68-69): run-time error JS1014: Invalid character: `
(2820,70-71): run-time error JS1004: Expected ';': {
(2820,121-122): run-time error JS1014: Invalid character: `
(3152,1-2): run-time error JS1107: Expecting more source characters
(2818,1-46): run-time error JS1301: End of file encountered before function is properly closed: function SetLimitReached(currentLength, elem)
(3152,1-2): run-time error JS1107: Expecting more source characters
(2813,1-47): run-time error JS1301: End of file encountered before function is properly closed: function SetInnerTextChar(currentLength, elem)
 */
/*global jQuery */
/*jshint browser:true */
/*!
* FitVids 1.1
*
* Copyright 2013, Chris Coyier - http://css-tricks.com + Dave Rupert - http://daverupert.com
* Credit to Thierry Koblentz - http://www.alistapart.com/articles/creating-intrinsic-ratios-for-video/
* Released under the WTFPL license - http://sam.zoy.org/wtfpl/
*
*/

; (function ($) {

    'use strict';

    $.fn.fitVids = function (options) {
        var settings = {
            customSelector: null,
            ignore: null
        };

        if (!document.getElementById('fit-vids-style')) {
            // appendStyles: https://github.com/toddmotto/fluidvids/blob/master/dist/fluidvids.js
            var head = document.head || document.getElementsByTagName('head')[0];
            var css = '.fluid-width-video-wrapper{width:100%;position:relative;padding:0;}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper object,.fluid-width-video-wrapper embed {position:absolute;top:0;left:0;width:100%;height:100%;}';
            var div = document.createElement("div");
            div.innerHTML = '<p>x</p><style id="fit-vids-style">' + css + '</style>';
            head.appendChild(div.childNodes[1]);
        }

        if (options) {
            $.extend(settings, options);
        }

        return this.each(function () {
            var selectors = [
              'iframe[src*="player.vimeo.com"]',
              'iframe[src*="youtube.com"]',
              'iframe[src*="youtube-nocookie.com"]',
              'iframe[src*="kickstarter.com"][src*="video.html"]',
              'object',
              'embed'
            ];

            if (settings.customSelector) {
                selectors.push(settings.customSelector);
            }

            var ignoreList = '.fitvidsignore';

            if (settings.ignore) {
                ignoreList = ignoreList + ', ' + settings.ignore;
            }

            var $allVideos = $(this).find(selectors.join(','));
            $allVideos = $allVideos.not('object object'); // SwfObj conflict patch
            $allVideos = $allVideos.not(ignoreList); // Disable FitVids on this video.

            $allVideos.each(function () {
                var $this = $(this);
                if ($this.parents(ignoreList).length > 0) {
                    return; // Disable FitVids on this video.
                }
                if (this.tagName.toLowerCase() === 'embed' && $this.parent('object').length || $this.parent('.fluid-width-video-wrapper').length) { return; }
                if ((!$this.css('height') && !$this.css('width')) && (isNaN($this.attr('height')) || isNaN($this.attr('width')))) {
                    $this.attr('height', 9);
                    $this.attr('width', 16);
                }
                var height = (this.tagName.toLowerCase() === 'object' || ($this.attr('height') && !isNaN(parseInt($this.attr('height'), 10)))) ? parseInt($this.attr('height'), 10) : $this.height(),
                    width = !isNaN(parseInt($this.attr('width'), 10)) ? parseInt($this.attr('width'), 10) : $this.width(),
                    aspectRatio = height / width;
                if (!$this.attr('id')) {
                    var videoID = 'fitvid' + Math.floor(Math.random() * 999999);
                    $this.attr('id', videoID);
                }
                $this.wrap('<div class="fluid-width-video-wrapper"></div>').parent('.fluid-width-video-wrapper').css('padding-top', (aspectRatio * 100) + '%');
                $this.removeAttr('height').removeAttr('width');
            });
        });
    };
    // Works with either jQuery or Zepto
})(window.jQuery || window.Zepto);
;
(function ($) {
    $(document).ready(function () {
        if (window.location.hash === '#addToProductList') {
            window.location.hash = '';
            $('[data-action="addToProductList"]').trigger('click');
        }
        else if (window.location.hash === '#showReserveInStoreModal') {
            window.location.hash = '';
            $('[data-action="showReserveInStoreModal"]').trigger('click');
        }

        $(window).on('resize', function () {
            positionOverlay($('.owl-stage-outer').first(), $('.owl-item:not(.cloned).active img').first(), $('.energyGroup').first());
        });
        setTimeout(function () {
            positionOverlay($('.owl-stage-outer').first(), $('.owl-item:not(.cloned).active img').first(), $('.energyGroup').first());

            /* show energy grade icon after positionOverlay() so the energygrade icon won't jump around the screen before it's position has been calculated */
            if ($(".energyGrade")[0] != undefined) {
                $('.energyGrade').show();
            }
        }, 500);
        calculateHeightForUpselNameDiv();

        $.event.trigger({ type: 'getSubscriptionModal', target: this });
    });

    $(document).on('click', '[data-action="prodSpecToggle"]', function (event) {
        productSpecToggle($(this).attr('href'));
    });

    $(document).on("click", "#bundle-descriptions .bundle-item", function () {
        var index = $(this).attr("data-item-index");
        $("#bundle-descriptions .bundle-item").removeClass("in");
        $(this).addClass("in");
        $("#bundle-descriptions .bundle-texts").removeClass("in");
        $("#bundle-descriptions .bundle-texts[data-item-index='" + index + "']").addClass("in");
    });

    $(document).on("click", "#bundled-specifications .bundle-item", function () {
        var index = $(this).attr("data-item-index");
        $("#bundled-specifications .bundle-item").removeClass("in");
        $(this).addClass("in");
        $("#bundled-specifications .bundle-texts").removeClass("in");
        $("#bundled-specifications .bundle-texts[data-item-index='" + index + "']").addClass("in");
    });


    var itemHeight = $(".scroller-matrix .firstProduct .panel-body.leftContent.item-full").outerHeight();
    var height = $(".list.spec-list li").outerHeight() * 4;
    $(".scroller-body.matrix").css("height", (height + itemHeight + 33) + "px");

    var expanded;
    $(".scroller-expand").on("click", function () {
        $(".expandText").toggleClass("hidden");
        $(".expandTextLess").toggleClass("hidden");
        if ($(this).find(".arrow-drop-up-gray").length > 0) {
            $(this).find(".arrow-drop-up-gray").removeClass("arrow-drop-up-gray").addClass("arrow-drop-down");
            var itemHeight = $(".scroller-matrix .firstProduct .panel-body.leftContent.item-full").outerHeight();
            var height = $(".list.spec-list li").outerHeight() * 4;
            $(".scroller-body.matrix").css("height", (height + itemHeight + 33) + "px");
            expanded = false;
        }
        else if ($(this).find(".arrow-drop-down").length > 0) {
            $(this).find(".arrow-drop-down").removeClass("arrow-drop-down").addClass("arrow-drop-up-gray");
            var itemHeight = $(".scroller-matrix .firstProduct .panel-body.leftContent.item-full").outerHeight();
            var height = $(".scroller-matrix  .rightContent.item-full").outerHeight();
            $(".scroller-body.matrix").css("height", (height + itemHeight + 23) + "px");
            expanded = true;
        }
    });

    $(window).on("resize", function () {
        var itemHeight = $(".scroller-matrix .firstProduct .panel-body.leftContent.item-full").outerHeight();
        var height = $(".list.spec-list li").outerHeight() * 4;
        $(".scroller-body.matrix").css("height", (height + itemHeight + 30) + "px");
        if (expanded) {
            var itemHeight = $(".scroller-matrix .firstProduct .panel-body.leftContent.item-full").outerHeight();
            var height = $(".list.spec-list li").outerHeight() * $(".firstProduct .list.spec-list li").length;
            $(".scroller-body.matrix").css("height", (height + itemHeight + 30) + "px");
        }
        else {
            var itemHeight = $(".scroller-matrix .firstProduct .panel-body.leftContent.item-full").outerHeight();
            var height = $(".list.spec-list li").outerHeight() * 4;
            $(".scroller-body.matrix").css("height", (height + itemHeight + 30) + "px");
        }

    });

    $(document).on('mouseenter', '.cPromotionItem .imageLink', function (event) {
        $(this).closest(".cPromotionItem").find(".headingLink").addClass("underline");/* .css("text-decoration", "underline");*/
    });

    $(document).on('mouseleave', '.cPromotionItem .imageLink', function (event) {
        $(this).closest(".cPromotionItem").find(".headingLink").removeClass("underline");/* .css("text-decoration", "none");*/
    });

})(jQuery);

function calculateHeightForUpselNameDiv() {
    var elements = $('div.upsellSetHeight');
    var setHeight = false;
    elements.each(function () {
        if ($(this).height() > 19) {
            setHeight = true;
        }
    });
    if (setHeight == true) {
        elements.each(function () {
            $(this).css("height", 40);
        });
    }
}

function openModal(modal) { $('#openModalContainer').html($('#' + modal).html()).modal('show'); }

function productSpecToggle(hash) {

    // Make sure the hash is valid
    if (hash.indexOf('#') > -1) {
        var target = hash.split('#')[2] || 'scrollTo';
        hash = '#' + hash.split('#')[1];

        if ($(hash).length > 0) {
            // Reset the accordion
            $('#accordion').children().children('.collapse.in').removeClass('in');
            $('#accordion').find('.arrow-drop-down').removeClass('arrow-drop-up');

            var expand = function () {
                $(hash).attr('style', '');
                $(hash).addClass('in');
                $(hash).parent().find('.arrow-drop-down').addClass('arrow-drop-up');

                if (navigator.userAgent.match(/(iPod|iPhone|iPad|Android)/)) {
                    window.scrollTo(0, 0); // first value for left offset, second value for top offset
                } else {
                    $('html, body').scrollTop(0);
                }

                // Default scroll-position
                var scrollTo = $(hash).parent().offset().top;

                // Is there a visible anchor for the scroll?
                var scroll = $(hash).find('.' + target + ' :visible');

                // Set scroll-position to anchor?
                if (scroll.length > 0)
                    scrollTo = scroll.offset().top;

                // Animate scroll
                //if (navigator.userAgent.match(/(iPod|iPhone|iPad|Android)/)) {
                //	window.scrollTo(0, scrollTo); // first value for left offset, second value for top offset
                //} else {
                $('html, body').animate({
                    scrollTop: scrollTo
                }, 500);
                //}
            };

            if ($('#collapseOne').data('loaded') === false) {
                $.get('/Product/GetProductSpecificationSection/', {
                    itemId: $('#headingOne').data('itemid'),
                    openInModal: $('#headingOne').data('openinmodal')
                }).done(function (resp) {
                    $('#collapseOne').html(resp);
                    $('#collapseOne').data('loaded', true);

                    expand();
                });
            }
            else {
                expand();
            }

            return true;
        }
    }
    return false;
}

function positionOverlay($carousel, $image, $elementToPosition, position) {
    if ($carousel.length) {
        switch (position) {
            case 'TopLeft':
                $elementToPosition.css('left', (($carousel.width() - $image.width()) / 2) + 'px');
                $elementToPosition.css('top', '0');
                break;
            case 'TopRight':
                $elementToPosition.css('right', (($carousel.width() - $image.width()) / 2) + 'px');
                $elementToPosition.css('top', '0');
                break;
            case 'BottomLeft':
                $elementToPosition.css('left', (($carousel.width() - $image.width()) / 2) + 'px');
                break;
            case 'BottomRight':
            default:
                $elementToPosition.css('right', (($carousel.width() - $image.width()) / 2) + 'px');
                break;
        }
    }
}

function selectWarehouseShop(productId, warehouseId, openInModal, self) {
    if (productId && warehouseId) {
        $.ajax({
            type: 'POST',
            contentType: 'application/x-www-form-urlencoded',
            url: '/Product/SetSelectedWarehouse',
            data: { itemId: productId, warehouseId: warehouseId, openInModal: openInModal },
            success: function (data) {
                if (data && data.length > 0) {
                    $('#stock-status').html(data).promise().done(function () {
                        $('#warehouse').addClass("in");
                        $("#selectedWareHouse").find(".arrow").toggleClass('arrow-drop-up');
                        $(".background-fade").addClass("fading");
                        window.setTimeout(function () {
                            $(".background-fade").removeClass("fading");
                        }, 300);

                        var respHtml = $($.parseHTML(data));
                        var canBeReserved = $(respHtml).find('#productbundleCanBeReserved').val();

                        if (canBeReserved == 'true') {
                            $('.reserveInStore').removeClass('hidden');
                            $('.cantReserveInStore').addClass('hidden');
                        }
                        else {
                            $('.reserveInStore').addClass('hidden');
                            $('.cantReserveInStore').removeClass('hidden');
                        }

                        var scrollTo = $("#stock-status").offset().top - 50;

                        if (($("html").scrollTop() + $("body").scrollTop() - scrollTo) > 0) {
                            $('html, body').animate({
                                scrollTop: scrollTo
                            }, 500);
                        }

                    });
                }
            }
        });
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "warehouse_stock_interactions";
        tracker.el = "select_warehouse";
        tracker.description = $(self).text();
        tracker.position = $(self).data("position") + "_" + $("#warehouseSelect").data("totalwarehouses");
        enhancedEcommerce.trackProductPage(tracker);

    }
}

function resetSelectWarehouseShop(productId, openInModal, self) {

    $.ajax({
        type: 'POST',
        contentType: 'application/x-www-form-urlencoded',
        url: '/Product/SetSelectedWarehouse',
        data: { itemId: productId, warehouseId: '', openInModal: openInModal },
        success: function (data) {
            if (data && data.length > 0) {
                $('#stock-status').html(data).promise().done(function () {
                    $('#warehouseSelect').addClass("in");
                    $("#pickwarehouseSelect").find(".arrow").toggleClass('arrow-drop-up');

                    var respHtml = $($.parseHTML(data));
                    var canBeReserved = $(respHtml).find('#productbundleCanBeReserved').val();

                    if (canBeReserved == 'true') {
                        $('.reserveInStore').removeClass('hidden');
                        $('.cantReserveInStore').addClass('hidden');
                    }
                    else {
                        $('.reserveInStore').addClass('hidden');
                        $('.cantReserveInStore').removeClass('hidden');
                    }
                });
            }
        }
    });
    var tracker = new Object();
    tracker.ec = "product_page";
    tracker.ea = "warehouse_stock_interactions";
    tracker.el = "change_warehouse";
    tracker.description = $("#selectedWareHouse").text();
    enhancedEcommerce.trackProductPage(tracker);
}

$(document).on('click', '#onlineStockstatus > .panel-heading[data-toggle=collapse]', function (e) {
    self = this;
    var freightsPanel = $("#freightsForProduct");
    var trackerText = 'expand_panel';
    if (freightsPanel.hasClass("in")) {
        freightsPanel.collapse("hide");
        $(this).find(".arrow").removeClass("arrow-drop-up");
        $(this).find(".arrow").addClass("arrow-drop-down");
        trackerText = 'collapse_panel';
    }
    else {
        if ($(this).data('postalcode') !== undefined && $(this).data('postalcode').toString().length > 0) {
            if (freightsPanel.data('freightsloaded') === false) {
                e.stopPropagation();
                var loadingDone = false;
                var itemId = $(this).data('itemid');
                var postalCode = $(this).data('postalcode');
                /* only show the loading spinner if the conent has not loaded after a certain amount of time.*/
                setTimeout(function () {
                    if (loadingDone === false) {
                        $("#onlineStockstatusPanel").find(".arrow").addClass("stock-status-collapse-spinner");
                        $("#onlineStockstatusPanel").find(".arrow").removeClass("arrow-drop-down");
                    }
                }, 1000);
                var __RequestVerificationToken = $('input[name="__RequestVerificationToken"]').val();
                $.post('/Product/GetFastestFreightsForProduct/', {
                    itemId: itemId,
                    postalCode: postalCode,
                    __RequestVerificationToken: __RequestVerificationToken
                }).done(function (resp) {
                    if (resp && resp.length > 0) {
                        loadingDone = true;
                        var respHtml = $($.parseHTML(resp));
                        var productFreightDescription = $(respHtml).find('#productFastestFreightDescription').val();

                        $(".freightDescription").html(productFreightDescription);
                        freightsPanel.html(resp);
                        freightsPanel.data('freightsloaded', true);
                        freightsPanel.collapse("show");

                        $("#onlineStockstatusPanel").find(".arrow").removeClass("stock-status-collapse-spinner");
                        $("#onlineStockstatusPanel").find(".arrow").removeClass("arrow-drop-down");
                        $("#onlineStockstatusPanel").find(".arrow").addClass("arrow-drop-up");
                    }
                });
            }
            else {
                freightsPanel.collapse("show");
                $(this).find(".arrow").removeClass("arrow-drop-down");
                $(this).find(".arrow").addClass("arrow-drop-up");
            }
        }
        else {
            freightsPanel.html('');
            freightsPanel.append($("#ChangePostalCode").clone());
            freightsPanel.find("#ChangePostalCode").removeClass("hidden");
            freightsPanel.collapse("show");
            $(this).find(".arrow").removeClass("arrow-drop-down");
            $(this).find(".arrow").addClass("arrow-drop-up");
        }
    }

    var tracker = new Object();
    tracker.ec = "product_page";
    tracker.ea = "online_stock_interactions";
    tracker.el = trackerText;
    enhancedEcommerce.trackProductPage(tracker);
});

$(document).on('click', "#freightsForProduct a", function (e) {
    var tracker = new Object();
    tracker.ec = "product_page";
    tracker.ea = "online_stock_interactions";
    tracker.el = "link_click";
    tracker.description = $(this).data("deliverygroup") + '_info';
    enhancedEcommerce.trackProductPage(tracker);
});


$(document).on('click', "#tradeInInfoTabs .btn", function (e) {
    $("#tradeInInfoTabs .btn").removeClass("btn-primary").addClass("btn-default");
    $(this).removeClass("btn-default").addClass("btn-primary");
});

$(document).on("change", "#tradeInCheckbox", function (e) {
    e.preventDefault();
    var checkbox = this;
    $(checkbox).prop("disabled", true);
    var checked = $(checkbox).prop("checked");
    if (checked) {
        $("#tradeInForm").collapse('show').promise().done(function () {
            if ($("#gradingSearch").hasClass("hidden") && $("#gradingItemsList").length === 0) {
                $("#gradingSearch").removeClass("hidden");
            }

            setTimeout(function () { $(checkbox).prop("disabled", false); }, 300);
        });
    }
    else {
        $("#tradeInForm").collapse('hide').promise().done(function () {
            setTimeout(function () { $(checkbox).prop("disabled", false); }, 300);
        });
    }
    $("button[data-confirmtradeinitems]").data('confirmtradeinitems', checked);
});

function changePostalCode() {
    var freightsPanel = $("#freightsForProduct");
    freightsPanel.html('');
    freightsPanel.append($("#ChangePostalCode").clone());
    var onlineStockstatusPanel = $("#onlineStockstatus .panel-heading:first-child");
    freightsPanel.find("#freightPostalCode").val(onlineStockstatusPanel.attr('data-postalcode'));
    freightsPanel.find("#ChangePostalCode").removeClass("hidden");
    freightsPanel.find('#GetFreightsForm').nonValidate({
        rules: {
            "freightPostalCode": {
                required: true,
                nonPostalCode: true
            }
        },
        messages: {
            'freightPostalCode': {
                required: NonValidation.defaultMessages.nonPostalCode.required,
            }
        }
    });
    $(".freightDescription").html($("#defaultFreightDescription").val());

    var tracker = new Object();
    tracker.ec = "product_page";
    tracker.ea = "online_stock_interactions";
    tracker.el = "link_click";
    tracker.description = "byt_postnummer";
    enhancedEcommerce.trackProductPage(tracker);
}

$(document).on("change", "#freightPostalCode", function (event) {
    $(this).removeClass("has-error");
    $(this).parent().find('.tooltip').removeClass('in');
});

$(document).on('click', '[data-action="getFreights"]', function (event) {
    event.preventDefault();
    var onlineStockstatusPanel = $("#onlineStockstatus .panel-heading:first-child");
    var itemId = onlineStockstatusPanel.data('itemid');
    var postalCodeInput = $(this).parent().find("#freightPostalCode");
    var postalCode = postalCodeInput.val();

    if ($(this).closest('#GetFreightsForm').valid()) {
        var spinner = $(this).ladda();
        spinner.ladda('start');
        var __RequestVerificationToken = $(this).closest('form').find('input[name="__RequestVerificationToken"]').val();
        $.post('/Product/GetFastestFreightsForProduct/', {
            itemId: itemId,
            postalCode: postalCode,
            __RequestVerificationToken: __RequestVerificationToken
        }).done(function (resp) {
            var freightsPanel = $("#freightsForProduct");
            if (resp && resp.length > 0) {

                var respHtml = $($.parseHTML(resp));
                var productFreightDescription = $(respHtml).find("#productFastestFreightDescription").val();

                $(".freightDescription").html(productFreightDescription);
                freightsPanel.html(resp);
                freightsPanel.data('freightsloaded', true);
                onlineStockstatusPanel.data('postalcode', postalCode);
            } else {
                postalCodeInput.attr('data-server-title', resp.ErrorMessage);
                postalCodeInput.addClass('has-error');
                postalCodeInput.closest('form').displayServerErrors();
                spinner.ladda('stop');
            }
        });
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "online_stock_interactions";
        tracker.el = "link_click";
        tracker.description = "show_delivery_options";
        enhancedEcommerce.trackProductPage(tracker);
    }
});

var subscriptionModal = (function ($) {
    'use strict';
    var $modal,
        operatorId = $('#Operator').val(),
        didChangeOperator = false,
        onlyGetModalContent = false;

    function showSubscriptions(selectedGroup, numbers) {
        var total = $(".select-subscription-button[data-groupIds~='" + selectedGroup + "']").length;
        var index = 0, maxNumbers = numbers || total;
        $("[id^=subscription-group-description]").hide();
        $("#subscription-group-description-" + selectedGroup).show();
        $(".select-subscription-button").hide();
        $(".select-subscription-button[data-groupIds~='" + selectedGroup + "']").each(function () {
            if (index < maxNumbers) {
                $(this).show();
                index++;
            }
        });

        $(".subscription-show-all").show();
        if (index >= total) {
            $(".subscription-show-all").hide();
        }
    }

    function sortSubscriptionList(selectedGroup) {
        $(".select-subscription-button[data-groupIds~='" + selectedGroup + "']").parents(".subscription-list-item").attr("data-sortOrder",
            function () {
                var groupIds = ($(this).find(".select-subscription-button").data("groupids") + "").split(" ");
                var sortOrders = ($(this).find(".select-subscription-button").data("sortorders") + "").split(" ");
                var indexOfGroup = groupIds.indexOf(selectedGroup);
                var so = sortOrders[indexOfGroup];
                return so;
            });


        var divs = $(".subscription-list-item");

        divs.sort(function (a, b) {
            var aSortOrder = $(a).attr("data-sortorder");
            var bSortOrder = $(b).attr("data-sortorder");

            var aMonthlyCost = parseInt($(a).find(".price-big").attr("data-price"));
            var bMonthlyCost = parseInt($(b).find(".price-big").attr("data-price"));


            if (aSortOrder == 0 && bSortOrder > 0) {
                return 1;
            }
            if (bSortOrder == 0 && aSortOrder > 0) {
                return -1;
            }

            if (aSortOrder == 0 && bSortOrder == 0) {
                if (aMonthlyCost < bMonthlyCost) {
                    return -1;
                } else if (aMonthlyCost > bMonthlyCost) {
                    return 1;
                } else {
                    return 0;
                }

            }
            else if (aSortOrder < bSortOrder) {
                return -1;
            }
            else if (aSortOrder > bSortOrder) {
                return 1;
            } else {
                return 0;
            }

        });

        $(".subscription-list").html(divs);

    }

    function subscriptionChanged(changeTarget) {
        var self = $(this),
            id = $(changeTarget).prop('id'),
            sectionId = $('#SectionId').val(),
            showPriceInclInsurance = $('#insurance').prop('checked'),
            animStyle = $modal.find('.modal-dialog').attr('style'),
            formElements;
        didChangeOperator = $('#Operator').val() !== operatorId;
        $modal.find('#SelectedControl').val(id);
        formElements = $modal.find('select, input').serialize();
        formElements = formElements + '&sectionId=' + sectionId +
            '&didChangeOperator=' + didChangeOperator +
            '&showPriceInclInsurance=' + showPriceInclInsurance +
            '&renderModal=true' +
            '&onlyGetContent=' + onlyGetModalContent;

        //$('#productAddToCart').block({ message: null });
        $.post('/Product/SubscriptionTabUpdate', formElements, function (data) {
            if (didChangeOperator) {
                operatorId = $('#Operator').val();
            }

            if (!data) {
                window.location.href = window.document.URL;
            }
            else if (data.RedirectUrl && data.RedirectUrl.length > 0) {
                window.location.href = data.RedirectUrl;
            } else {
                $modal.addClass('subscriptionLoaded');
                $modal.html(data);
                if (!$modal.hasClass('in'))
                    $modal.modal('show', changeTarget);
                $modal.find('.modal-dialog').attr('style', animStyle);
                $modal.find('select').nonSelect();
                //var focusControl = '#' + id;
                if ($(self).next('.richSelectionBox').length > 0) {
                    $(self).next('.richSelectionBox').focus();
                }
                initModalSubscription();
            }
        });
    }

    function initModalSubscription() {
        $modal.find('select').off('change');
        $modal.find('select').on('change', function () {
            subscriptionChanged(this);
        });

        $modal.find('input[type="checkbox"]').off('change');
        $modal.find('input[type="checkbox"]').on('change', function () {
            subscriptionChanged(this);

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "subscription_interactions";
            tracker.el = $(this).prop('checked') ? "select_additional_service" : "unselect_additional_service";
            var description = $("label[for='" + $(this).attr('id') + "']").text();
            tracker.description = description;
            tracker.position = $(this).data("position") + "_" + $("#additionalServices").data("totalservices");
            enhancedEcommerce.trackProductPage(tracker);
        });

        $modal.find('.subscriptionOptions a.btn').off('click');
        $modal.find('.subscriptionOptions a.btn').on('click', function (event) {
            event.preventDefault();
            $("input:hidden[name='" + $(this).data("input") + "']").val($(this).data("click"));

            trackSubscription(this);

            subscriptionChanged(this);
            return false;
        });



        $modal.find('a.reload').click(function (event) {
            event.preventDefault();
            subscriptionChanged(this);
        });

        $modal.find('.subscriptionOptions .subscriptionConfiguratorSubSelector .showPartialPayment a').click(function (event) {
            event.preventDefault();
            $('.subscriptionOptions .subscriptionConfiguratorSubSelector .showPartialPayment').addClass('hidden');
            $('.subscriptionOptions .subscriptionConfiguratorSubSelector .editPartialPayment').removeClass('hidden');
        });

        $('[data-toggle="popover"]').popover();

        jQuery.validator.addMethod("notEqual", function (value, element, param) {
            return this.optional(element) || value != param;
        }, "Please specify a different (non-default) value");

        $('#subscriptionForm').nonValidate({
            rules: {
                "OldNumber": {
                    required: true,
                    nonPhone: true
                },
                "OldOperator": {
                    required: true,
                    nonOperator: true
                }
            },
            messages: {
                "OldNumber": {
                    required: NonValidation.defaultMessages.nonPhone.required
                },
                "OldOperator": {
                    required: NonValidation.defaultMessages.nonOperator.required
                }
            }
        });

        var redirectedFrom = $modal.attr('data-redirectedfrom');
        if (typeof redirectedFrom !== 'undefined' && redirectedFrom != null && redirectedFrom.length > 0)
            $('#RedirectedFromItemId').val(redirectedFrom);

        $modal.on('changed', '.subscriptionConfiguratorDropDownWide', function (event) {
            showOutOfStock();
        });

        showOutOfStock();
    }

    function trackSubscription(self) {
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "subscription_interactions";

        var total = '';
        var action = '';
        var description = '';
        var position = '';
        var input = $(self).attr("data-input");

        switch (input) {
            case 'operator':
                action = 'select_operator';
                description = $(self).attr("title");
                position = $(self).data("position");
                total = $(".subscriptionOptions").data("totaloperators");
                break;
            case 'Subscription':
                action = 'select_subscription_type';
                description = $(self).attr("title");
                position = $(self).data("position");
                total = $(".subscriptionOptions").data("totalsubscriptions");
                break;
            case 'Duration':
                action = 'select_duration';
                description = $(self).text();
                position = $(self).data("position");
                total = $(".subscriptionOptions").data("totaldurations");
                break;
            case 'InstallmentDuration':
                action = 'select_payment_period';
                description = $(self).text();
                position = $(self).data("position");
                total = $(".subscriptionOptions").data("totalinstallmentdurations");
                break;
            case 'NumberType':
                action = 'select_keep_phone_number';
                description = $(self).text();
                position = 'not';
                total = 'available';
                break;
            default:
                action = 'select_not_available';
                description = 'not_available';
                position = 'not';
                total = 'available';
        }

        tracker.el = action;
        tracker.description = description;
        tracker.position = position + "_" + total;
        enhancedEcommerce.trackProductPage(tracker);
    }

    function showOutOfStock() {
        var msg = $('#subscriptionModal').find('.outOfStock').first();
        if (msg !== 'undefined') {

            if (!msg.hasClass('hidden')) {
                msg.addClass('hidden');
            }

            $('.notInStock').each(function () {

                var sel = $(this).parent().find("[value = '" + $(this).val() + "']").first();

                if ((sel !== 'undefined') && (sel.attr('selected') === 'selected')) {
                    msg.removeClass('hidden');
                }

            });
        }
    }

    var documentReady = function () {
        $(document).on('click', function (event) {
            $('#helpListPassword').popover('hide');
        });

        $('#productGallery').nonGallery({
            debug: false,
            lazyLoad: false,
            useDots: true,
            autoplayHoverPause: false,
            tempCarouselId: "#tempProductCarousel"
        });

        $('#gallery-fullImageModal').nonGallery({
            debug: false,
            ignoreThumbnails: false,
            useDots: false,
            lazyLoad: true,
            autoplayHoverPause: false,
        });

        $('.upsellMobileOnly.gallery .upsell-gallery').nonGallery({
            debug: false,
            ignoreThumbnails: true,
        });

        var height = 200;
        $('.upsellMobileOnly.gallery .upsell-gallery .item').each(function () {
            if ($(this).height() > height)
                height = $(this).height();
        });
        $('.upsellMobileOnly.gallery .upsell-gallery .item').each(function () {
            $(this).height(height);
        });

        initModalSubscription();

        $(document).on('show.bs.collapse hide.bs.collapse', '[data-action="toggleCollapseArrow"]', function (event) {
            var collapsing = event.type === 'hide';
            toggleCollapseArrow(event.target, collapsing);

            // Refresh webKit browsers so iFramed youTube-videos does not leave artifacts on canvas
            if (event.target.id === 'collapseFive' && event.type === 'show') { //Product description
                event.target.style.webkitTransform = 'scale(1)';
            }
        });

        $(document).on('click', '[data-action="showHelpListPassword"]', function (event) {
            setTimeout(function () {
                $('#helpListPassword').popover('show');
            }, 200);
        });

        /* Bootstrap shown is triggered after transition is complete.
         * Here we know the panel is showing, and can scroll to its position.
         */

        $(document).on('show.bs.collapse hide.bs.collapse', '#dynamicMenuCollapse', function (event) {
            var $title = $(this).prev('.panel-heading').find('.panel-title');
            if ($(event.target).attr('id') === 'dynamicMenuCollapse') {
                if (event.type === 'show') {
                    $title.text($title.attr('data-hideContent'));
                } else {
                    $title.text($title.attr('data-showContent'));
                }
            }
        });

        $(document).on('shown.bs.collapse', '[data-action="toggleCollapseArrow"]', function (event) {
            scrollToTarget(event.target);
        });


        function scrollToTarget(target) {
            var currentScroll = $(window).scrollTop();
            var scroll = parseInt($(target).offset().top);

            if (currentScroll > scroll) {
                var parentHeight = $(target).prev('.panel-heading').outerHeight();

                $('html, body').stop().animate({
                    scrollTop: scroll - parentHeight
                }, 400);
            }
        }


        function toggleCollapseArrow(target, collapsing) {
            var $target = $(target),
                $subMenu = $target.prev(),
                $heading = $target.closest('.panel').find('.panel-heading');

            // Check if we have a submenu-header above us that has arrows
            if ($subMenu.length > 0 && ($subMenu.attr('data-target') === '#' + $target.attr('id') &&
                ($subMenu.hasClass('subMenuUpArrow') || $subMenu.hasClass('subMenuDownArrow')))) {
                if (collapsing) {
                    $subMenu.removeClass('subMenuUpArrow').addClass('subMenuDownArrow');
                } else {
                    $subMenu.removeClass('subMenuDownArrow').addClass('subMenuUpArrow');
                }
            } else if ($heading.length > 0 && $heading.attr('data-target') === '#' + $target.attr('id')) {
                if (collapsing) {
                    $heading.find('.arrow-drop-down').removeClass('arrow-drop-up');
                    $heading.find('.upgradedhighlight').removeClass("hidden");
                } else {
                    $heading.find('.arrow-drop-down').addClass('arrow-drop-up');
                    $heading.find('.upgradedhighlight').addClass("hidden");
                }

            }

            var tracker = new Object();
            tracker.event = "panels";
            tracker.ec = "panels";
            tracker.ea = collapsing ? 'collapse' : 'expand';
            tracker.el = $($heading).text();
            enhancedEcommerce.trackComponent(tracker);
        }

        function urlSubscription(url, itemId) {
            if ($('#SelectSubscription').length > 0) {

                $("#subscriptionForm").validate();

                if ($("#subscriptionForm").valid()) {
                    var sectionId = $('#SectionId').val();
                    var showPriceInclInsurance = $('#productPurchaseBoxContainer').find('[name=insurance-checkbox]').prop('checked');

                    if (typeof showPriceInclInsurance == 'undefined')
                        showPriceInclInsurance = false;

                    var formElements = $modal.find('select, input').serialize();

                    formElements = formElements + '&sectionId=' + sectionId +
                        '&didChangeOperator=false' +
                        '&showPriceInclInsurance=' + showPriceInclInsurance +
                        '&renderModal=false' +
                        '&validate=true' +
                        '&newItemId=' + itemId +
                        '&dontSelectSubscription=' + ($('#SelectSubscription').val() == 0);


                    $.ajax({
                        type: 'POST',
                        contentType: 'application/x-www-form-urlencoded',
                        url: '/Product/SubscriptionTabUpdate',
                        data: formElements,
                        async: false,
                        success: function (data) {
                            if (data && data.length > 0) {
                                $('#productPurchaseBoxContainer').html($(data)).promise().done(function () {
                                    $('#productPurchaseBoxContainer select').nonSelect();
                                    $('.subscription-box span[data-action="updateRadio"]').nonRadio();
                                    $('#productPurchaseBoxContainer [data-action="updateCheckbox"]').nonCheckbox();
                                    initTextSwatch();
                                    initGrading();
                                });
                                url = url + "#AddSub";
                            }
                        }
                    });
                }
            }

            return url;
        }

        $(document).on('change', '#productPurchaseBoxContainer #variantSelect', function () {
            var hideModal = $(this).attr("hide-modal") || false;

            var newUrl = $(this).val();
            var itemId = $(this).children("option:selected").data("itemid");

            if (newUrl.indexOf('?') > -1)
                newUrl = newUrl + "&";
            else
                newUrl = newUrl + "?";

            newUrl = newUrl + "showSubscriptionModal=" + hideModal;

            var activeTab = 'standard';
            if ($(".price-box.upgraded-box").is(":visible")) {
                activeTab = 'upgraded';
            }
            if (activeTab) {
                newUrl = newUrl + "&pTab=" + activeTab;
            }

            if (!($(this).data('isupgraded') == true)) {
                newUrl = urlSubscription(newUrl, itemId);
            }

            window.location.href = newUrl;
        });

        $(document).on('change', '#productSubscriptionBox #variantSelect', function () {
            var newUrl = $(this).val();
            var itemId = $(this).children("option:selected").data("itemid");

            newUrl = urlSubscription(newUrl, itemId);

            window.location.href = newUrl;
        });

        $(document).on('click', '#productPurchaseBoxContainer .swatchBox:not(.selected)', function () {
            var hideModal = $(this).attr("hide-modal") || false;
            var itemId = $(this).data("itemid");

            var newUrl = $(this).data("url");

            if (newUrl.indexOf('?') > -1)
                newUrl = newUrl + "&";
            else
                newUrl = newUrl + "?";

            newUrl = newUrl + "showSubscriptionModal=" + hideModal;

            var activeTab = 'standard';
            if ($(".price-box.upgraded-box").is(":visible")) {
                activeTab = 'upgraded';
            }
            if (activeTab) {
                newUrl = newUrl + "&pTab=" + activeTab;
            }

            if (!($(this).data('isupgraded') == true)) {
                newUrl = urlSubscription(newUrl, itemId);
            }

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "product_variant_interactions";
            tracker.el = "change_variant";
            tracker.description = $(this).prop("title");
            tracker.position = $(this).data("position") + "_" + $(".swatchContainer").data("totalvariants");
            enhancedEcommerce.trackProductPage(tracker);

            window.location.href = newUrl;
        });

        $(document).on('getSubscriptionModal', function (event) {
            var self = event.target;
            $modal.modal('show', self);
        });

        $(document).on('loaded.bs.modal', '#subscriptionModal', function () {
            var animStyle = $modal.find('.modal-dialog').attr('style');
            $modal.find('.modal-dialog').attr('style', animStyle);
            $modal.find('select').nonSelect();
            var focusControl = '#Operator';
            if ($(focusControl).next('.richSelectionBox').length > 0) {
                $(focusControl).next('.richSelectionBox').focus();
            }
            initModalSubscription();
            $modal.addClass('subscriptionLoaded');
            operatorId = $modal.find('#Operator').val();
        });

        $(document).on('click', '[data-action="showSubscriptionModal"]', function (event) {
            event.preventDefault();
            $.event.trigger({ type: 'getSubscriptionModal', target: this });
        });

        $(document).on('click', '[data-target="#subscriptionModal"]', function (event) {
            $modal.find('select').nonSelect();
            initModalSubscription();
        });

        $(document).on('click', '[data-action="remove-subscription"]', function (event) {
            SelectSubscribtion(event.target, true);
        });

        $(document).on("change", "#radio-noSubscription", function (event) {
            $('#SelectSubscription').val(0);
            SelectSubscribtion(event.target);
        });
        $(document).on('click', '[data-action="showUpgraded"]', function (event) {
            event.preventDefault();
            var alt = $(this).text();
            $(this).text($(this).data("alttext"));
            $(this).data("alttext", alt);
            $(".toggle-when-upgraded").toggleClass("hidden");

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "vÃ¤xla_upp_interactions";
            tracker.el = "link_click";
            tracker.description = alt;
            enhancedEcommerce.trackProductPage(tracker);
        });

        function SelectSubscribtion(target, remove) {
            var renderModal, self = target;
            if (remove) {
                $('#Operator').val(0);
                didChangeOperator = true;
                renderModal = false;
                $modal.removeClass('subscriptionLoaded');
            } else {
                var selectedValue = $('#Operator option[selected="selected"]').val();
                if (typeof selectedValue !== 'undefined' && selectedValue !== null)
                    $('#Operator').val(selectedValue).change();
                $.event.trigger({ type: 'getSubscriptionModal', target: self });
                return;
            }

            var sectionId = $('#SectionId').val();
            var showPriceInclInsurance = $('#productPurchaseBoxContainer').find('[name=insurance-checkbox]').prop('checked');
            if (typeof showPriceInclInsurance == 'undefined')
                showPriceInclInsurance = false;


            var formElements = $modal.find('select, input').serialize();
            formElements = formElements + '&sectionId=' + sectionId +
                '&didChangeOperator=' + didChangeOperator +
                '&showPriceInclInsurance=' + showPriceInclInsurance +
                '&renderModal=' + renderModal;

            $.post('/Product/SubscriptionTabUpdate', formElements, function (data) {
                if (data) {
                    if (data.RedirectUrl && data.RedirectUrl.length > 0) {
                        window.location.href = data.RedirectUrl;
                    }
                }
                $('#productPurchaseBoxContainer').html(data).promise().done(function () {
                    $('#productPurchaseBoxContainer select').nonSelect();
                    $('.subscription-box span[data-action="updateRadio"]').nonRadio();
                    $('#productPurchaseBoxContainer [data-action="updateCheckbox"]').nonCheckbox();
                    initTextSwatch();
                    initGrading();
                });
            });
        }

        $(document).on('change', '#productSubscriptionBox', function (event) {

            var sectionId = $('#SectionId').val();
            var showPriceInclInsurance = $('#insurance').prop('checked');
            if (typeof showPriceInclInsurance == 'undefined')
                showPriceInclInsurance = false;

            if ($("#subCheckboxNumberType").is(':checked')) {
                $("#subNumberType").val("OldNumber");
            } else {
                $("#subNumberType").val("NewNumber");
            }

            var formElements = $('#productSubscriptionBox').find('select, input').serialize();
            formElements = formElements + '&sectionId=' + sectionId +
                '&didChangeOperator=' + didChangeOperator +
                '&showPriceInclInsurance=' + showPriceInclInsurance +
                '&renderModal=false' +
                '&validate=true';

            $.post('/Product/SetSubscription', formElements, function (data) {
                if (data && data.length > 0) {
                    $('#productSubscriptionBox').html(data).promise().done(function () {
                        $('#productSubscriptionBox select').nonSelect();
                        $('#productSubscriptionBox [data-action="updateCheckbox"]').nonCheckbox();
                    });
                } else {
                    nonFlash.showError(data.Message);
                }
            });

        });

        $(document).on('click', '.select-subscription-button', function (event) {
            var button = event.target;

            var sectionId = $('#SectionId').val();
            var showPriceInclInsurance = $('#insurance').prop('checked');
            if (typeof showPriceInclInsurance == 'undefined')
                showPriceInclInsurance = false;
            var formElements = $(button).parents('form').find('input').serialize();
            formElements = formElements + '&sectionId=' + sectionId +
                '&didChangeOperator=' + didChangeOperator +
                '&showPriceInclInsurance=' + showPriceInclInsurance +
                '&renderModal=false' +
                '&validate=true';

            $.post('/Product/SetSubscription', formElements, function (data) {
                if (data && data.length > 0) {
                    $('#productSubscriptionBox').html(data).promise().done(function () {
                        $('#productSubscriptionBox select').nonSelect();
                        $('#productSubscriptionBox [data-action="updateCheckbox"]').nonCheckbox();
                        window.setTimeout(function () {
                            $(".background-fade").addClass("fading");
                            window.setTimeout(function () {
                                $(".background-fade").removeClass("fading");
                            }, 300);
                        }, 400);
                    });
                } else {
                    nonFlash.showError(data.Message);
                }
            });

            $("#subscriptionListModal").modal('hide');

            event.preventDefault();
        });

        $(document).on('hide.bs.modal', '#subscriptionModal', function (event) {
            initTextSwatch();
            initGrading();
        });

        $(document).on('show.bs.modal', '#subscriptionModal', function (event) {
            if ($(event.relatedTarget).hasClass('suggested-subscription')) {
                var button = event.relatedTarget;

                $modal = $("#subscriptionModal");

                var sectionId = $('#SectionId').val(),
                    showPriceInclInsurance = $('#insurance').prop('checked'),
                    animStyle = $modal.find('.modal-dialog').attr('style');
                didChangeOperator = $('#Operator').val() !== operatorId;
                var formElements = $(button).parents('form').find('input').serialize();

                formElements = formElements + '&sectionId=' + sectionId +
                    '&didChangeOperator=' + didChangeOperator +
                    '&showPriceInclInsurance=' + showPriceInclInsurance +
                    '&renderModal=true' +
                    '&onlyGetContent=false';

                $.ajax({
                    type: 'POST',
                    url: '/Product/SubscriptionTabUpdate',
                    data: formElements,
                    async: false,
                    success: function (data) {
                        if (didChangeOperator) {
                            operatorId = $('#Operator').val();
                        }

                        if (!data) {
                            window.location.href = window.document.URL;
                        }
                        else if (data.RedirectUrl && data.RedirectUrl.length > 0) {
                            window.location.href = data.RedirectUrl;
                        } else {
                            $("#subscriptionModal").addClass('subscriptionLoaded');
                            $("#subscriptionModal").html(data);
                            $("#subscriptionModal").find('.modal-dialog').attr('style', animStyle);
                            $("#subscriptionModal").find('select').nonSelect();
                            initModalSubscription();
                        }
                    }
                });
            }
        });


        //to display correct product page on reload
        if (!!window.performance && window.performance.navigation.type === 2) {
            if (document.location.hash === "#AddSub") {
                document.location.hash = "";
                window.location.reload();
            }
        }

        $(document).on('click', '#chooseSubscription', function (event) {
            $("#subscriptionForm").validate();

            if ($("#subscriptionForm").valid()) {
                var sectionId = $('#SectionId').val();
                var showPriceInclInsurance = $('#productPurchaseBoxContainer').find('[name=insurance-checkbox]').prop('checked');

                if (typeof showPriceInclInsurance == 'undefined')
                    showPriceInclInsurance = false;
                var formElements = $modal.find('select, input').serialize();
                formElements = formElements + '&sectionId=' + sectionId +
                    '&didChangeOperator=' + didChangeOperator +
                    '&showPriceInclInsurance=' + showPriceInclInsurance +
                    '&renderModal=false' +
                    '&validate=true' +
                    '&getAll=true';

                $.post('/Product/SubscriptionTabUpdate', formElements, function (data) {
                    if (data && data.length > 0) {
                        $('#productPurchaseBoxContainer').html($(data)).promise().done(function () {
                            $('#productPurchaseBoxContainer select').nonSelect();
                            $('.subscription-box span[data-action="updateRadio"]').nonRadio();
                            $('#productPurchaseBoxContainer [data-action="updateCheckbox"]').nonCheckbox();
                            initTextSwatch();
                            initGrading();
                        });

                        $modal.attr('data-customActiveTriggerId', 'productSubscription');
                        $modal.modal('hide');
                        trackSubscriptionAdd();
                        window.location.hash = 'AddSub';
                    } else {
                        $modal.html(data);
                        var animStyle = $modal.find('.modal-dialog').attr('style');
                        $modal.find('.modal-dialog').attr('style', animStyle);
                        $modal.find('select').nonSelect();
                        var focusControl = '#Operator';
                        if ($(focusControl).next('.richSelectionBox').length > 0) {
                            $(focusControl).next('.richSelectionBox').focus();
                        }
                        initModalSubscription();
                        $("#subscriptionForm").displayServerErrors();
                    }
                });
            } else {
                initModalSubscription();
                var element = $('#subscriptionModal').find('.has-error:first');
                if (element.length > 0) {
                    $('#subscriptionModal').animate({ scrollTop: element.position().top + element.offsetParent()[0].offsetTop }, 500);
                }
            }

            event.preventDefault();
        });

        function trackSubscriptionAdd() {
            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "subscription_interactions";
            tracker.el = "subscription_added";
            var operator = $("#SelectedOperator").val();
            var subscriptionType = $("#SelectedSubscriptionType").val();
            tracker.description = operator + '_' + subscriptionType;
            enhancedEcommerce.trackProductPage(tracker);
        };

        $(document).on("click", ".group-select .btn-primary", function () {
            var selectedGroup = $(this).find("input").val();
            sortSubscriptionList(selectedGroup);
            showSubscriptions(selectedGroup, 4);
        });
        $(document).on("click", ".subscription-show-all", function () {
            var selectedGroup = $(".subscription.group-select .active").find("input").val();
            showSubscriptions(selectedGroup);
        });

        $(document).on("loaded.bs.modal", "#subscriptionListModal", function () {
            var selectedGroup = $(".subscription.group-select .active").find("input").val();
            sortSubscriptionList(selectedGroup);
            showSubscriptions(selectedGroup, 4);
        });

        $(document).on("click", "[data-action='SubscriptionListOpen']", function (event) {
            var self = this;
            $("#subscriptionListModal").modal('show', self);
        });

        $(document).on("click", "[data-action='subscriptionCustomerInfoOpen']", function (event) {
            //var formElements = $("#productSubscriptionBox").find('select, input').serialize();
            var self = this;
            var $subModal = $('#subscriptionCustomerInfoModal');
            //$subModal.attr('data-view-params', JSON.stringify(formElements));
            $subModal.modal('show', self);
        });

        $(document).on("loaded.bs.modal", "#subscriptionCustomerInfoModal", function (event) {
            $("#subscriptionCustomerInfoModal").find('select').nonSelect();
            if ($("option:selected", "#NumberType").val() === "OldNumber") {
                $(".additionalSubInfo").removeClass("hidden");
            }

            $('#storeSubscriptionForm').nonValidate({
                rules: {
                    "code": {
                        required: true,
                        minlength: 6,
                        onlyNumerical: true
                    },
                    "oldNumber": {
                        required: true,
                        nonPhone: true
                    }
                },
                messages: {
                    "code": {
                        required: NonValidation.defaultMessages.nonShortSSN.required,
                        minlength: NonValidation.defaultMessages.nonShortSSN.required,
                        onlyNumerical: NonValidation.defaultMessages.nonShortSSN.required
                    },
                    messages: {
                        "oldNumber": {
                            required: NonValidation.defaultMessages.nonPhone.required,
                            nonPhone: NonValidation.defaultMessages.nonPhone.required
                        }
                    }
                }
            });

        });

        $(document).on("change", "#NumberType", function (e) {
            if ($("option:selected", this).val() === "OldNumber") {
                $(".additionalSubInfo").removeClass("hidden");
            } else {
                $(".additionalSubInfo").addClass("hidden");
            }
        });

        $(document).on("click", "[data-action='SubscriptionCode']", function (event) {
            var formElements = $modal.find('select, input').serialize();
            var self = this;
            var $subModal = $('#subscriptionCodeModal');
            $subModal.attr('data-view-params', JSON.stringify(formElements));
            $subModal.modal('show', self);
        });


        $(document).on("click", "[data-action='SubscriptionLink']", function (event) {
            var formElements = $modal.find('select, input').serialize();
            var self = this;
            var $subModal = $('#subscriptionLinkModal');
            $subModal.attr('data-view-params', JSON.stringify(formElements));
            $subModal.modal('show', self);
        });

        $(document).on('click', '#cancelSubscription', function (event) {
            $modal.modal('hide');
            event.preventDefault();
        });

        $(document).on("click", "#ShowMoreInfoLink", function (event) {
            $('#ShowMoreInfoLink').hide();
            $('#ShowLessInfoLink').show();

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "subscription_interactions";
            tracker.el = "link_click";
            tracker.description = "visa_mer_information";
            enhancedEcommerce.trackProductPage(tracker);
        });

        $(document).on("click", "#ShowLessInfoLink", function (event) {
            $('#ShowMoreInfoLink').show();
            $('#ShowLessInfoLink').hide();

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "subscription_interactions";
            tracker.el = "link_click";
            tracker.description = "visa_mindre_information";
            enhancedEcommerce.trackProductPage(tracker);
        });

        $(document).on('show.bs.collapse hide.bs.collapse', '#subscription-plan-collapse', function (event) {
            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "subscription_interactions";
            tracker.el = $(this).hasClass("in") ? "collapse_payment_plan_panel" : "expand_payment_plan_panel";
            enhancedEcommerce.trackProductPage(tracker);
        });


        var collapse = function (collapse) {
            $('#accordion').children().children('.collapse.in').removeClass('in');
            $('#accordion').find('.arrow-drop-down').removeClass('arrow-drop-up');
            $(collapse).addClass("in");
            $(collapse).removeAttr("style");
            $('[data-target="' + collapse + '"]').find('.arrow-drop-down').addClass('arrow-drop-up');
        };

        /* Get reviews for the number of stars the user clicked on */
        $(document).on("click", "a#averageStar", function (e) {
            var getRatingsWithStars = $(this).data("starvalue");
            var itemId = $(this).data('itemid');
            var openInModal = $(this).data('openinmodal');
            var filterBylocale = $(this).data('locale');
            var sortBy = $(this).data('sortby');
            $.get('/Product/GetReviewsSection/', {
                itemId: itemId,
                openInModal: openInModal,
                getReviewsWithRating: getRatingsWithStars,
                filterByLanguangeLocale: filterBylocale,
                sortBy: sortBy
            }).done(function (resp) {
                $('#collapseTwo').html(resp);
                bazaarVoice.initReviews();
                $("#reviewSortByOptions").nonSelect();
                var position = $("#viewReviewCollapse .panel-body .row .review-sort-by-country").offset().top;
                $("HTML, BODY").animate({
                    scrollTop: position
                }, 350);
            });
            event.preventDefault();
        });


        /* Filter reviews by language locale */
        $(document).on("click", "a#filterByLanguageLocale", function (e) {
            var getRatingsWithStars = $(this).data("starvalue");
            var itemId = $(this).data('itemid');
            var openInModal = $(this).data('openinmodal');
            var filterBylocale = $(this).data('locale');
            var sortBy = $(this).data('sortby');
            $.get('/Product/GetReviewsSection/', {
                itemId: itemId,
                openInModal: openInModal,
                getReviewsWithRating: getRatingsWithStars,
                filterByLanguangeLocale: filterBylocale,
                sortBy: sortBy
            }).done(function (resp) {
                $('#collapseTwo').html(resp);
                bazaarVoice.initReviews();
                $("#reviewSortByOptions").nonSelect();
                var position = $("#viewReviewCollapse .panel-body .row .review-sort-by-country").offset().top;
                $("HTML, BODY").animate({
                    scrollTop: position
                }, 350);
            });
            event.preventDefault();
        });

        /* Show all reviews from all locales when clicked */
        $(document).on("click", "a#filterByLanguageLocaleNone", function (e) {
            var getRatingsWithStars = $(this).data("starvalue");
            var itemId = $(this).data('itemid');
            var openInModal = $(this).data('openinmodal');
            var sortBy = $(this).data('sortby');
            $.get('/Product/GetReviewsSection/', {
                itemId: itemId,
                openInModal: openInModal,
                getReviewsWithRating: getRatingsWithStars,
                sortBy: sortBy,
            }).done(function (resp) {
                $('#collapseTwo').html(resp);
                bazaarVoice.initReviews();
                $("#reviewSortByOptions").nonSelect();
                var position = $("#viewReviewCollapse .panel-body .row .review-sort-by-country").offset().top;
                $("HTML, BODY").animate({
                    scrollTop: position
                }, 350);
            });
            event.preventDefault();
        });
        /* review sort by language on hover */
        $('#reviewFilterByCountry').mouseover(function () {
            $('#reviewFilterByCountry').css('background-color', '#f1fafe !important');
        });

        /* Review sort by */
        $(document).on('change', '#reviewSortByOptions', function (e) {
            $(this).nonSelect();
            var getRatingsWithStars = $(this).data("starvalue");
            var itemId = $(this).data('itemid');
            var openInModal = $(this).data('openinmodal');
            var filterBylocale = $(this).data('locale');
            var sortBy = $(this).data('sortby');

            $.get('/Product/GetReviewsSection/', {
                itemId: itemId,
                openInModal: openInModal,
                getReviewsWithRating: getRatingsWithStars,
                filterByLanguangeLocale: filterBylocale,
                sortBy: $(this).val()
            }).done(function (resp) {
                $('#collapseTwo').html(resp);
                bazaarVoice.initReviews();
                $("#reviewSortByOptions").nonSelect();
            });
            event.preventDefault();
        });

        /* Expand Top Review on click */
        $(document).on('click', '#expandReviewText', function (e) {
            $("#reviewTextExpanded").show();
            $("#reviewTextCollapsed").hide();
            event.preventDefault();
        });

        // Open reviewCollapse and animate scroll to reviewHeader-position. Hide all other.
        $(document).on('click', '[data-action="writeReview"]', function (event) {
            event.preventDefault();
            var hideHeight = 0,
                $hideCollapse = $('#accordion > .panel > .collapse.in').not('#collapseTwo'),
                showReviewCollapse = function (top) {
                    if ($('#collapseTwo').data('loaded') === false) {
                        var getRatingsWithStars = $("#headingTwo").data("starvalue");
                        var filterBylocale = $("#headingTwo").data('locale');

                        $.get('/Product/GetReviewsSection/', {
                            itemId: $('#headingTwo').data('itemid'),
                            openInModal: $('#headingTwo').data('openinmodal'),
                            getReviewsWithRating: getRatingsWithStars,
                            filterByLanguangeLocale: filterBylocale
                        }).done(function (resp) {
                            $('#collapseTwo').html(resp);
                            $('#collapseTwo').data('loaded', true);
                            collapse("#collapseTwo");

                            $('html, body').animate({
                                scrollTop: top
                            }, 350);
                            bazaarVoice.initReviews();
                            $("#reviewSortByOptions").nonSelect();
                        });
                    } else {
                        collapse("#collapseTwo");
                        $('html, body').animate({
                            scrollTop: top
                        }, 350);
                    }
                };

            if ($hideCollapse.length > 0) {
                if ($hideCollapse.parent().index() < $('#collapseTwo').parent().index()) {
                    hideHeight = $hideCollapse.height();
                }

                showReviewCollapse($('#collapseTwo').parent().offset().top - hideHeight);
            } else {
                showReviewCollapse($('#collapseTwo').parent().offset().top);
            }

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "general_interactions";
            tracker.el = "ratings_click";
            tracker.description = $(event.currentTarget).hasClass("writeReviewLink") ? $(event.target).text() : "ratings_icon";
            enhancedEcommerce.trackProductPage(tracker);

        });

        $(document).on('click', '.breadcrumb a', function (e) {
            var breadCrumb = '';
            var total = $(".breadcrumb").data("totalbreadcrumbcount");
            var position = $(this).data("position");
            var breads = $(".breadcrumb a");
            $.each(breads, function (index, val) {
                if (index < position) {
                    if (index > 0)
                        breadCrumb += "/";
                    breadCrumb += $(val).text();
                }

            });
            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "general_interactions";
            tracker.el = "breadcrumbs_click";
            tracker.description = breadCrumb;
            tracker.position = position + '_' + total;
            enhancedEcommerce.trackProductPage(tracker);
        });

        $(document).on('click', '#compareProduct', function (e) {

            var tracker = new Object();
            tracker.ec = "product_page";
            tracker.ea = "general_interactions";
            tracker.el = "compare_products_click";
            enhancedEcommerce.trackProductPage(tracker);
        });


        $(document).on('click', '.votingReview', function (e) {
            var clickedCircle = $(e.target.closest('.votingReview'));
            if (clickedCircle.hasClass('upvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('upvote');

                clickedCircle.addClass('upvote-active');
                clickedCircle.siblings('.downvote').removeClass('downvote');

                let reviewId = clickedCircle.siblings('.reviewId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitReviewFeedback',
                    data: { reviewId: reviewId.val(), value: 'Positive' },
                    cache: true,
                    dataType: 'json'
                });
            }
            else if (clickedCircle.hasClass('downvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('downvote');

                clickedCircle.addClass('downvote-active');
                clickedCircle.siblings('.upvote').removeClass('upvote');

                let reviewId = clickedCircle.siblings('.reviewId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitReviewFeedback',
                    data: { reviewId: reviewId.val(), value: 'Negative' },
                    cache: true,
                    dataType: 'json'
                });
            }
        });

        //New endpoint for voting on questions (Q&A)
        $(document).on('click', '.votingQuestion', function (e) {
            var clickedCircle = $(e.target.closest('.votingQuestion'));
            if (clickedCircle.hasClass('upvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('upvote');

                clickedCircle.addClass('upvote-active');
                clickedCircle.siblings('.downvote').removeClass('downvote');

                let questionId = clickedCircle.siblings('.questionId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitQuestionFeedback',
                    data: { questionId: questionId.val(), value: 'Positive' },
                    cache: true,
                    dataType: 'json'
                });
            }
            else if (clickedCircle.hasClass('downvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('downvote');

                clickedCircle.addClass('downvote-active');
                clickedCircle.siblings('.upvote').removeClass('upvote');

                let questionId = clickedCircle.siblings('.questionId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitQuestionFeedback',
                    data: { questionId: questionId.val(), value: 'Negative' },
                    cache: true,
                    dataType: 'json'
                });
            }
        });

        //New endpoint for voting on answers (Q&A)
        $(document).on('click', '.votingQuestionAnswer', function (e) {
            var clickedCircle = $(e.target.closest('.votingQuestionAnswer'));
            if (clickedCircle.hasClass('upvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('upvote');

                clickedCircle.addClass('upvote-active');
                clickedCircle.siblings('.downvote').removeClass('downvote');

                let answerId = clickedCircle.siblings('.answerId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitAnswerFeedback',
                    data: { answerId: answerId.val(), value: 'Positive' },
                    cache: true,
                    dataType: 'json'
                });
            }
            else if (clickedCircle.hasClass('downvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('downvote');

                clickedCircle.addClass('downvote-active');
                clickedCircle.siblings('.upvote').removeClass('upvote');

                let answerId = clickedCircle.siblings('.answerId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitAnswerFeedback',
                    data: { answerId: answerId.val(), value: 'Negative' },
                    cache: true,
                    dataType: 'json'
                });
            }
        });

//New endpoint for voting on review comments (reviews)
        $(document).on('click', '.votingReviewComment', function (e) {
            var clickedCircle = $(e.target.closest('.votingReviewComment'));
            if (clickedCircle.hasClass('upvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('upvote');

                clickedCircle.addClass('upvote-active');
                clickedCircle.siblings('.downvote').removeClass('downvote');

                let reviewCommentId = clickedCircle.siblings('.reviewCommentId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitReviewCommentFeedback',
                    data: { reviewCommentId: reviewCommentId.val(), value: 'Positive' },
                    cache: true,
                    dataType: 'json'
                });
            }
            else if (clickedCircle.hasClass('downvote')) {
                let numberElement = clickedCircle.children('.numberOfVotes');
                let numberOfVotes = numberElement.text();
                numberOfVotes = parseInt(numberOfVotes) + 1;
                numberElement.text(numberOfVotes);

                clickedCircle.removeClass('downvote');

                clickedCircle.addClass('downvote-active');
                clickedCircle.siblings('.upvote').removeClass('upvote');

                let reviewCommentId = clickedCircle.siblings('.reviewCommentId');

                $.ajax({
                    type: 'POST',
                    url: '/BazaarVoice/SubmitReviewCommentFeedback',
                    data: { reviewCommentId: reviewCommentId.val(), value: 'Negative' },
                    cache: true,
                    dataType: 'json'
                });
            }
        });

        if (!productSpecToggle(window.location.hash)) {
            // Open ProductSpec or TechnicalSpec if tablet or desktop
            if ($(window).width() > (767 - 20)) {
                var noDesc = $('#collapseFive #noDesc');
                if (noDesc.length > 0 && $('#headingOne').length > 0) {
                    var itemId = $('#headingOne').data('itemid');
                    openInModal: $('#headingOne').data('openinmodal');

                    $.get('/Product/GetProductSpecificationSection/', {
                        itemId: itemId,
                        openInModal: openInModal
                    }).done(function (resp) {
                        $('#collapseOne').html(resp);
                        $('#collapseOne').data('loaded', true);
                        $('#accordion').children().children('.collapse.in').removeClass('in');
                        $('#accordion').find('.arrow-drop-down').removeClass('arrow-drop-up');
                    });
                } else {
                    var openInModal = $('#headingOne').data('openinmodal');
                    if (typeof openInModal === 'undefined' || openInModal == "False") {

                        if ($('#collapseSeven').length > 0) {
                            $('#collapseSeven').addClass('in');
                        } else {
                            $('#collapseFive').addClass('in');
                        }
                        $('[data-target="#collapseFive"]').find('.arrow-drop-down').addClass('arrow-drop-up');
                    }
                }
            }
        }
        $('.productSpec').fitVids({ ignore: '.embed-responsive' });

        if ($('.showRedirectedSubscription').exists())
            $modal.modal('show');

        if (window.location.href.indexOf("pTab=upgraded") > -1)
            $("[data-action='showUpgraded']").trigger("click");

        $(document).on("click", '[data-action="viewDescription"]', function (event) {
            event.preventDefault();
            var hideHeight = 0,
                $hideCollapse = $('#accordion > .panel > .collapse.in').not('#collapseFive'),
                showReviewCollapse = function (top) {
                    collapse("#collapseFive");
                    $('html, body').animate({
                        scrollTop: top
                    }, 350);

                };

            if ($hideCollapse.length > 0) {
                if ($hideCollapse.parent().index() < $('#collapseFive').parent().index()) {
                    hideHeight = $hideCollapse.height();
                }

                showReviewCollapse($('#collapseFive').parent().offset().top - hideHeight);
            } else {
                showReviewCollapse($('#collapseFive').parent().offset().top);
            }
        });
    };

    var $modal;
    $(document).ready(function () {
        $modal = $('#subscriptionModal');

        $(document).on('hidden.bs.modal', '#subscriptionModal', function () {
            if (!$('#RedirectedFromItemId').val())
                return;

            var sectionId = $('#SectionId').val();
            var formElements = $modal.find('select, input').serialize();
            formElements = formElements + '&sectionId=' + sectionId;

            $.post('/Product/RedirectBackToOriginalProduct', formElements, function (data) {
                if (!data) {
                    window.location.href = window.document.URL;
                }
                else if (data.RedirectUrl.length > 0) {
                    window.location.href = data.RedirectUrl;
                }
            });
        });

        documentReady();

        // #headingTwo is used to scroll down to reviews from the beginning from BazaarVoice emails
        if (window.location.href.indexOf("#headingTwo") > 0) {
            $('[data-action="writeReview"]').trigger('click');

            setTimeout(function () {
                $('#accordion').children().children('.panel-heading.in').removeClass('in');
            }, 500);

        }
    });

    var subscriptionModalReady = function (modalContainer) {
        $modal = modalContainer;
        onlyGetModalContent = true;
        initModalSubscription();
    };

    var publicApi = {
        subscriptionModalReady: subscriptionModalReady
    };

    return publicApi;
}(window.jQuery));

$(document).on("change", ".subscription-box input", function () {
    $(this).parents("ul").find("li").toggleClass("list-group-item-warning");
});

$(document).on("change", "#radio-subscription", function () {
    $("#chooseSubscription").trigger("click");
});

$(document).on("click", "#insuranceInfoBody a", function () {
    var tracker = new Object();
    tracker.ec = "product_page";
    tracker.ea = "insurance_interactions";
    tracker.el = "link_click";
    tracker.description = $(this).text();
    enhancedEcommerce.trackProductPage(tracker);
});

$(document).on("click", ".energyGroup a", function () {
    var tracker = new Object();
    tracker.ec = "product_page";
    tracker.ea = "product_image_carousel";
    tracker.el = "overlay_link_click";
    tracker.description = 'produktblad';
    enhancedEcommerce.trackProductPage(tracker);
});
/**
 * ProductTexts
 */

(function () {
    $(document).ready(function () {
        $(document).on('DOMNodeInserted', function (e) {
            if ($(e.target).hasClass('productsContainer')) {
                if ($('#collapseFour').length < 1) {
                    $('#moreAccessoriesLink').addClass('hidden');
                }
            }
        });

        $('.productsContainer .cPromotionItem').find(".name").equalHeights();

        $(document).on('click', '#moreAccessoriesLink', function (e) {

            if ($("#collapseFour").length > 0) {

                if ($('#collapseFour').data('loaded') === false) {
                    e.stopPropagation();
                    var itemId = $(this).data('itemid');
                    if (itemId === undefined) {
                        itemId = $("#headingFour").data('itemid');
                    }

                    $.get('/Product/GetAccessoriesSection/',
                        {
                            itemId: itemId
                        })
                        .done(function (resp) {
                            $('#collapseFour').html(resp);
                            $('#collapseFour').data('loaded', true);
                            $("#collapseFour").collapse({
                                parent: $("#accordion")
                            });
                        });
                }

                $(this).attr('href', '');

                $("#collapseFour").collapse('show');
                var scrollTo = $('#collapseFour').parent().offset().top;

                //if (navigator.userAgent.match(/(iPod|iPhone|iPad|Android)/)) {
                //	window.scrollTo(0, scrollTo); // first value for left offset, second value for top offset
                //} else {
                $('html, body').animate({
                    scrollTop: scrollTo
                }, 500);
                //}
            }
        });

        $('#headingFour').on('click', function (e) {
            if ($('#collapseFour').data('loaded') === false) {
                e.stopPropagation();
                var loadingDone = false;
                var itemId = $(this).data('itemid');
                if (itemId === undefined) {
                    itemId = $("#headingFour").data('itemid');
                }
                setTimeout(function () {
                    if (loadingDone === false) {
                        $('#headingFour').addClass('collapse-spinner');
                        $('#headingFour').find('.arrow-control-heading-four').removeClass('arrow-drop-up');
                        $('#headingFour').find('.arrow-control-heading-four').removeClass('arrow-drop-down');
                    }
                }, 1000);
                $.get('/Product/GetAccessoriesSection/',
                    {
                        itemId: itemId
                    })
                    .done(function (resp) {
                        loadingDone = true;
                        $('#collapseFour').html(resp);
                        $('#accordion').find('.collapse-spinner').removeClass('collapse-spinner');
                        $('#accordion').find('.arrow-control-heading-four').addClass('arrow-drop-down');
                        $('#accordion').find('.arrow-control-heading-four').addClass('arrow-drop-up');

                        $('#collapseFour').data('loaded', true);
                        $("#collapseFour").collapse({
                            parent: $("#accordion")
                        });
                    });
            }
        });

        $('#headingTwo').on('click', function (e) {
            if ($('#collapseTwo').data('loaded') === false) {
                e.stopPropagation();
                var loadingDone = false;
                var itemId = $(this).data('itemid');
                var openInModal = $(this).data('openinmodal');
                var getRatingsWithStars = $(this).data("starvalue");
                var filterBylocale = $(this).data('locale');

                setTimeout(function () {
                    if (loadingDone === false) {
                        $('#headingTwo').addClass('collapse-spinner');
                        $('#headingTwo').find('.arrow-control-heading-two').removeClass('arrow-drop-down');
                    }
                }, 1000);

                $.get('/Product/GetReviewsSection/', {
                    itemId: itemId,
                    openInModal: openInModal,
                    getReviewsWithRating: getRatingsWithStars,
                    filterByLanguangeLocale: filterBylocale
                }).done(function (resp) {
                    loadingDone = true;
                    $('#collapseTwo').html(resp);

                    $('#accordion').find('.collapse-spinner').removeClass('collapse-spinner');
                    $('#accordion').find('arrow-control-heading-two').addClass('arrow-drop-up');
                    $('#accordion').find('.arrow-control-heading-two').addClass('arrow-drop-down');

                    $('#collapseTwo').data('loaded', true);
                    $("#collapseTwo").collapse({
                        parent: $("#accordion")
                    });
                    $("#reviewSortByOptions").nonSelect();
                    bazaarVoice.initReviews();
                });

            }
        });

        $('#headingThree').on('click', function (e) {
            if ($('#collapseThree').data('loaded') === false) {
                e.stopPropagation();
                var loadingDone = false;
                var itemId = $(this).data('itemid');
                var openInModal = $(this).data('openinmodal');

                setTimeout(function () {
                    if (loadingDone === false) {
                        $('#headingThree').addClass('collapse-spinner');
                        $('#headingThree').find('.arrow-control-heading-three').removeClass('arrow-drop-down');
                    }
                }, 1000);
                $.get('/Product/GetProductQASection/', {
                    itemId: itemId,
                    openInModal: openInModal
                }).done(function (resp) {
                    loadingDone = true;
                    $('#collapseThree').html(resp);
                    $('#accordion').find('.collapse-spinner').removeClass('collapse-spinner');
                    $('#accordion').find('arrow-control-heading-three').addClass('arrow-drop-up');
                    $('#accordion').find('.arrow-control-heading-three').addClass('arrow-drop-down');

                    if ($('span[itemprop="availability"]').text() === "Discontinued") {

                        $('#noBazaarVoiceQuestionsMessage').remove();
                    }

                    $('#collapseThree').data('loaded', true);
                    $("#collapseThree").collapse({
                        parent: $("#accordion")
                    });
                    bazaarVoice.initQA();
                });
            }
        });

        $('#headingOne').on('click', function (e) {
            if ($('#collapseOne').data('loaded') === false) {
                e.stopPropagation();
                var loadingDone = false;
                var itemId = $(this).data('itemid');
                var openInModal = $(this).data('openinmodal');
                setTimeout(function () {
                    if (loadingDone === false) {
                        $("#headingOne").addClass('collapse-spinner');
                        $("#headingOne").find('.arrow-control-heading-one').removeClass('arrow-drop-down');
                    }
                }, 1000);
                $.get('/Product/GetProductSpecificationSection/', {
                    itemId: itemId,
                    openInModal: openInModal
                }).done(function (resp) {
                    loadingDone = true;
                    $('#collapseOne').html(resp);
                    $('#accordion').find('.collapse-spinner').removeClass('collapse-spinner');
                    $('#accordion').find('arrow-control-heading-one').addClass('arrow-drop-up');
                    $('#accordion').find('.arrow-control-heading-one').addClass('arrow-drop-down');
                    $('#collapseOne').data('loaded', true);
                    $("#collapseOne").collapse({
                        parent: $("#accordion")
                    });
                });
            }
        });
    });
}());

/**
 * PurchaseBox
 */

(function () {

    $(document).on('click', '#upgradedInfoModalBody a', function () {
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "vÃ¤xla_upp_interactions";
        tracker.el = "link_click";
        tracker.description = $(this).text();
        enhancedEcommerce.trackProductPage(tracker);
    });

    $(document).on('click', '#priceCompareLink', function () {
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "prisjakt_interactions";
        tracker.el = "link_click";
        tracker.description = $(this).text();
        enhancedEcommerce.trackProductPage(tracker);
    });


    $(document).on('click', '.productSpec a', function () {
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "info_tabs_interactions";
        tracker.el = "link_click";
        var header = ($(this).closest(".panel.panel-default").find("h2:first").text() || "not").trim();
        var text = ($(this).text() || "available").trim();
        tracker.description = header + '_' + text;
        tracker.linkType = $(this).hasClass("btn") ? 'cta' : 'text_link';
        enhancedEcommerce.trackProductPage(tracker);
    });

    $(document).on('click', '.x-article a', function () {
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "general_interactions";
        tracker.el = "product_condition_click";
        tracker.description = $(this).text();
        enhancedEcommerce.trackProductPage(tracker);
    });
}());




/**
 * SuggestModal
 */

(function () {

    function addValidation() {
        var defaultMessages = NonValidation.defaultMessages;
        var form = $('#suggestToFriendModal').find('form');
        form.nonValidate({
            rules: {
                "SuggesterName": {
                    required: true,
                    nonSuggesterName: true
                },
                "SuggesterEmail": {
                    required: true,
                    nonSuggesterEmail: true
                },
                "FriendEmail": {
                    required: true,
                    nonFriendEmail: true
                },
                "SuggestMessage": {
                    nonSuggestMessage: true
                }
            },
            messages: {
                "SuggesterName": {
                    required: defaultMessages.nonSuggesterName.required
                },
                "SuggesterEmail": {
                    required: defaultMessages.nonSuggesterEmail.required
                },
                "FriendEmail": {
                    required: defaultMessages.nonFriendEmail.required
                }
            }
        });
    };

    $(document).on('click', '[data-action="showSuggestModal"]', function (event) {
        event.preventDefault();
        self = this;

        $('#suggestToFriendModal').modal("show", self);

        $(document).on("loaded.bs.modal", "#suggestToFriendModal", function () {
            addValidation();
            $(document).off("loaded.bs.modal", "#suggestToFriendModal");
        });
    });

    // ProductListModal
    $(document).on('click', '[data-action="addToProductList"]', function (event) {
        event.preventDefault();
        var self = this,
            itemId = $(this).attr('data-itemid'),
            $targetModal = $($(self).attr('data-target'));


        $targetModal.modal('show', self);

        $(document).on("loaded.bs.modal", "#" + $targetModal.attr('id'), function () {
            $('#addNewList').attr('data-itemId', itemId);
            $('#newProductListPassword').attr('data-itemId', itemId);
            $('#newProductListName').attr('data-itemId', itemId);

            $('#selectProductList').nonSelect();
            $('#ItemCount').nonSelect();

            $('#newProductListType').nonSelect();

            $('.product-list-password-section').find('[data-action="updateRadio"]').nonRadio();

            $('#helpListType').popover();
            $('#helpListPassword').popover();
            $('#newProductListName').focus();

            $(document).off("loaded.bs.modal", "#" + $targetModal.attr('id'));
        });
    });

    $(document).on('click', '[data-action="printProductInfo"]', function (event) {
        event.preventDefault();

        var itemId = $(event.currentTarget).attr('data-itemid');
        window.open('/Product/PrintProduct/' + itemId, '_blank', 'scrollbars=yes,status=no,location=no,menubar=no,resizable=no,titlebar=yes,toolbar=no');


    });

    $(document).on('click', '[data-action="sendMail"]', function (event) {
        event.preventDefault();

        var $button = $(this),
            $form = $button.closest('form'),
            formData;

        if (!$form.valid() || $button.attr('data-productlist')) {
            return;
        }

        formData = $form.serialize();

        $.post('/Product/SendSuggestionMail', formData).done(function (resp) {
            if (resp.success) {
                $('#captchaError').hide();
                var $modal = $(event.target).closest('.modal');
                $modal.modal('hide');
                nonFlash.showSuccess(resp.msg);
            } else if (resp.captchaFailed && resp.captchaFailed === true) {
                $(('#captchaErrorMsg')).text(resp.msg);
                $('#captchaError').show();
            }
        });
    });
}());



/**
 * ReserveInStore
 */
(function () {
    $(document).on('click', '[data-action="showReserveInStoreModal"]', function (event) {
        var self = this, targetModal = $($(self).attr('data-target'));

        targetModal.modal('show', self);
    });

    $(document).on("loaded.bs.modal", "#reserveInStoreModal", function () {
        $("#reserveInStoreModal .reserveInStoreBody").find('select').nonSelect();

        $('#ItemReserveForm').nonValidate({
            rules: {
                "phoneNo": {
                    required: true,
                    nonPhone: true
                }
            },
            messages: {
                "phoneNo": {
                    required: NonValidation.defaultMessages.nonPhone.required
                }
            }
        });
    });

    $(document).on('submit', '#ItemReserveForm', function (event) {
        event.preventDefault();
        $('.reserveErrorText').addClass('hidden');
        if (!$(this).valid()) {
            return;
        }

        var formElements = $(this).serialize();
        var sku = $(this).find("input[name='itemId'").val();

        $.ajax({
            type: "POST",
            cache: false,
            url: "/Product/MakeReservation",
            data: formElements,
        })
            .done(function (json) {
                if (json && json.length > 0) {
                    $("#reserveInStoreModal .reserveInStoreBody").html(json);

                    var tracker = new Object();
                    tracker.ec = "product_page";
                    tracker.ea = "paxa_interactions";
                    tracker.el = "paxa_registered";
                    tracker.description = sku;
                    enhancedEcommerce.trackProductPage(tracker);

                } else {
                    $('.reserveErrorText').html(json.html);
                    $('.reserveErrorText').removeClass('hidden');
                }
            });
        return false;
    });

    $(document).on('click', '#integrityPolicy a', function (event) {
        var tracker = new Object();
        tracker.ec = "product_page";
        tracker.ea = "paxa_interactions";
        tracker.el = "link_click";
        tracker.description = $(this).text();
        enhancedEcommerce.trackProductPage(tracker);
    });

    $(document).on('click', '#SelectWarehouseCloseButton', function (event) {
        $('#reserveInStoreModal').modal('hide');
        event.preventDefault();
    });
}());

/**
 * Reviews and Q&A
 */
var bazaarVoice = (function ($) {
    'use strict';
    var currentPage = 0,
        request;

    /**
     * Parse the page-param from href-attribute if possible, otherwise
     * returns -1.
     */
    function getPageFromUrl(url) {
        var pageParam,
            pageNum;
        if (url && url.indexOf('page=') !== -1) {
            pageParam = url.match(/page=(\d+)&/);
            if (pageParam && pageParam.length >= 1) {
                pageNum = parseInt(pageParam[1], 10);
                if ($.isNumeric(pageNum)) {
                    return pageNum;
                }
            }
        }
        return -1;
    }

    /**
      * Sets the list opacity and returns a promise that gets
      * resolved when the animation is done.
      */
    function setListOpacity($parent, child, opacity) {
        var deferred = $.Deferred();
        if ($.support.transition.end) {
            $parent.find('.' + child).css('opacity', opacity).one($.support.transition.end, deferred.resolve).emulateTransitionEnd(1000);
        } else {
            deferred.resolve();
        }
        return deferred.promise();
    }

    /**
     * Replaces reviewsContainer content and returns a promise that
     * gets resolved when the replace is done.
     */
    function replaceContent(resp) {
        var deferred = $.Deferred();
        if (resp && resp.Html) {
            var $div = $('<div/>').html(resp.Html);

            $('#reviewsContainer').empty().html($div.find('#reviewsContainer').html()).promise().done(function () {
                request = undefined;
                deferred.resolve();
            });
        } else {
            deferred.reject();
        }
        return deferred.promise();
    }

    /**
     * Replaces reviewsContainer content and returns a promise that
     * gets resolved when the replace is done.
     */
    function replaceQAContent(resp) {
        var deferred = $.Deferred();
        if (resp && resp.Html) {
            var $div = $('<div/>').html(resp.Html);

            $('#QAContainer').empty().html($div.find('#QAContainer').html()).promise().done(function () {
                request = undefined;
                deferred.resolve();
            });
        } else {
            deferred.reject();
        }
        return deferred.promise();
    }

    var initReviews = function () {
        $('#bazaarVoiceSubmitReview').find('[data-action="updateCheckbox"]').nonCheckbox();
        $('#bazaarVoiceSubmitReview').find('[data-action="updateRadio"]').nonRadio();
        $('.submitReviewForm [data-action="updateCheckbox"]').nonCheckbox();

        $('#reviewsContainer').on('show.bs.collapse hide.bs.collapse', '.comments', function (event) {
            var $link = $(event.target).prev('.showMoreLink');
            if ($link.length > 0) {
                if (event.type === 'show') {
                    $link.find('span').removeClass('subMenuSmallDownArrow').addClass('subMenuSmallUpArrow');
                } else {
                    $link.find('span').removeClass('subMenuSmallUpArrow').addClass('subMenuSmallDownArrow');
                }
            }
        });

        $('#reviewsContainer').on('click', '.pagination a', function (event) {
            var page,
                url;
            event.preventDefault();

            // Abort previous request if any since it is obsolete.
            if (request !== undefined && request.state() === 'pending') {
                request.abort();
            }
            url = $(this).attr('href');

            // get the selected rating 
            var selectedRating = $('#hiddenSelectedStarRating').attr('name');
            if (selectedRating) {
                url += '&getReviewsWithRating=' + selectedRating;
            }

            // get the selected locale
            var selectedLocale = $('#hiddenSelectedLocaleName').attr('name');
            if (selectedLocale) {
                url += '&filterByLanguangeLocale=' + selectedLocale;
            }

            page = getPageFromUrl(url);

            setListOpacity($('#reviewsContainer'), 'reviewsList', 0.5).done(function () {
                request = $.get(url);
                request.done(replaceContent).done(function () {
                    $('.submitReviewForm [data-action="updateCheckbox"]').nonCheckbox();
                    // if we are moving to a greater page, animate scroll to first review on new page,
                    // otherwise scroll instantly to the bottom to show navigation. 
                    if (currentPage < page) {
                        $('body,html').animate({
                            scrollTop: $('#reviewsContainer .reviewsList li').first().offset().top
                        }, 350);
                    } else if (currentPage > page) {
                        $(window).scrollTop(($('#reviewsContainer').offset().top + $('#reviewsContainer').height()) - $(window).height());
                    }
                    currentPage = page;
                }).fail(function () {
                    // Reset opacity if we fail
                    setListOpacity($('#reviewsContainer'), 'reviewsList', 1);
                });
            });
        });
    };

    var initQA = function () {
        $('#bazaarVoiceSubmitQuestion').find('[data-action="updateCheckbox"]').nonCheckbox();
        $('#bazaarVoiceAnswerQuestion').find('[data-action="updateCheckbox"]').nonCheckbox();
        $('#bazaarVoiceSubmitQuestion').find('[data-action="updateRadio"]').nonRadio();
        $('.bazaarAnswer [data-action="updateCheckbox"]').nonCheckbox();

        $('#QAContainer').on('show.bs.collapse hide.bs.collapse', '.questionsAndAnswers', function (event) {
            var $link = $(event.target).prev('.showMoreLink');
            if ($link.length > 0) {
                if (event.type === 'show') {
                    $link.find('span').removeClass('subMenuSmallDownArrow').addClass('subMenuSmallUpArrow');
                } else {
                    $link.find('span').removeClass('subMenuSmallUpArrow').addClass('subMenuSmallDownArrow');
                }
            }
        });


        $('#QAContainer').on('click', '.pagination a', function (event) {
            var page,
                url;
            event.preventDefault();

            // Abort previous request if any since it is obsolete.
            if (request !== undefined && request.state() === 'pending') {
                request.abort();
            }

            url = $(this).attr('href');
            page = getPageFromUrl(url);

            setListOpacity($('#QAContainer'), 'questionList', 0.5).done(function () {
                request = $.get(url);
                request.done(replaceQAContent).done(function () {
                    $('.bazaarAnswer [data-action="updateCheckbox"]').nonCheckbox();
                    // if we are moving to a greater page, animate scroll to first review on new page,
                    // otherwise scroll instantly to the bottom to show navigation. 
                    if ($(window).width() < 768) {
                        if (currentPage < page) {
                            $('body,html').animate({
                                scrollTop: $('#QAContainer .questionList li').first().offset().top
                            }, 350);
                        } else if (currentPage > page) {
                            $(window).scrollTop(($('#QAContainer').offset().top + $('#QAContainer').height()) - $(window).height());
                        }
                    }
                    currentPage = page;
                }).fail(function () {
                    // Reset opacity if we fail
                    setListOpacity($('#QAContainer'), 'questionList', 1);
                });
            });
        });
    };

    var publicApi = {
        initReviews: initReviews,
        initQA: initQA
    };

    return publicApi;
}(jQuery));

function calcTextWidth(minSize, maxSize, div) {

    var divSize = maxSize;
    var divHeight = parseInt(div.css('height').replace('px', ''));

    div.css('overflow-wrap', 'break-word');
    div.css('font-size', divSize + 'px');

    var newHeight = parseInt(div.css('height').replace('px', ''));

    while (divSize > minSize && newHeight > divHeight) {
        divSize = divSize - 1;
        div.css('font-size', divSize + 'px');
        newHeight = parseInt(div.css('height').replace('px', ''));
    }

    div.css('overflow-wrap', '');
    div.css('overflow', 'hidden');

    divSize = divSize - 8;

    if (divSize < minSize)
        divSize = minSize;

    div.css('font-size', divSize + 'px');

    return divSize;
}

function initTextSwatch() {
    // Do NOT change these values!!!
    var min = 15;
    var max = 15;

    $('.textSwatch').each(function () {
        // Shrink from max to fit
        var val = calcTextWidth(min, 15, $(this));

        if (val < max)
            max = val;
    });

    $('.textSwatch').each(function () {
        // Equal size
        $(this).css('font-size', max + 'px');
        // Unveil
        $(this).css('color', 'black');
    });
}

(function () {
    $(document).ready(function () {
        initTextSwatch();
    });
}());

/**
 * Fix for equal height for products dynamically added to productdescription
 */
(function () {
    $(document).ready(function () {
        $('#collapseFive').find('.productDescTextContainer h2').equalHeights();
        $('#collapseFive').find('.productDescTextContainer p').equalHeights();
    });

    $('#accordion').on('show.bs.collapse hide.bs.collapse', '#collapseFive', function (event) {
        $('#collapseFive').find('.productDescTextContainer h2').equalHeights();
        $('#collapseFive').find('.productDescTextContainer p').equalHeights();
    });

}());

(function () {

    $(document).ready(function () {

        $(document).on("click", function () {
            $("[data-action='glossary']").popover("hide");
        });

        $(document).on("click", "[data-action='glossary']", function (event) {
            event.stopPropagation();
            var self = $(this);
            var url = $(this).attr("data-link");

            if (self.attr("data-content") === "") {
                $.get(url, function (data) {

                    self.attr("data-content", $("<span>" + data.Content + "</span>").text());
                    self.attr("title", data.Title);
                    self.popover('show');
                });
            }
            else {
                self.popover('toggle');
            }

        });

    });

}());


function CalcChars(e, elem) {
    var numberLimit = Number($(elem).siblings().find('.numbers-left').attr('data-value'));
    var currentLength = (Number($(elem)[0].value.length) < numberLimit) ? (numberLimit - Number($(elem)[0].value.length)) : (Number($(elem)[0].value.length) > numberLimit) ? 0 : (numberLimit - Number($(elem)[0].value.length));

    if (e.keyCode === 8 /* Backspace */ ||
        e.keyCode === 9 /* Tab */ ||
        e.keyCode === 16 /* TabBackwards */ ||
        e.keyCode === 46 /* Delete */) {
        SetCharOnBackSpace(currentLength, elem);
    } else {
        SetCharOnKeyPress(currentLength, elem);
    }
}

function SetCharOnBackSpace(currentLength, elem) {
    var numberLimit = Number($(elem).siblings().find('.numbers-left').attr('data-value'));
    if (Number($(elem)[0].value.length) === numberLimit) {
        $(elem).closest('.min-text-length').hide();
        $(elem).closest('.min-TextLengthReached').show();
        return SetInnerTextChar(currentLength, elem);
    }
    else if (Number($(elem)[0].value.length) < numberLimit) {
        $(elem).closest('.min-text-length').show();
        $(elem).closest('.min-TextLengthReached').hide();
        return SetInnerTextChar(currentLength, elem);
    } else {
        return SetLimitReached(currentLength, elem);
    }
}

function SetCharOnKeyPress(currentLength, elem) {
    var numberLimit = Number($(elem).siblings().find('.numbers-left').attr('data-value'));
    if (currentLength < numberLimit && currentLength > 0) {
        $(elem).closest('.min-text-length').show();
        $(elem).closest('.min-TextLengthReached').hide();
        return SetInnerTextChar(currentLength, elem);
    } else {
        $(elem).closest('.min-text-length').hide();
        $(elem).closest('.min-TextLengthReached').show();
        return SetLimitReached(currentLength, elem);
    }
}

function SetInnerTextChar(currentLength, elem) {
    $(elem).siblings().find('.numbers-left')[0].value = currentLength;
    return $(elem).siblings().find('.numbers-left')[0].innerText = `${$(elem).siblings().find('.numbers-left')[0].value}`;
}

function SetLimitReached(currentLength, elem) {
    $(elem).siblings().find('.numbers-left')[0].value = 0;
    return $(elem).siblings().find('.numbers-left')[0].innerText = `${$(elem).siblings().find('.numbers-left')[0].value}`;
}

$(document).on("keyup", "#reviewText", function (e) {
    CalcChars(e, '#reviewText');
});

$(document).on("keyup", "#questionDetails", function (e) {
    CalcChars(e, '#questionDetails');
});

;
(function ($) {
    'use strict';

    /**
     * Attaches listeners for set and remove compare item. 
     */
    function attachListeners() {
        // CompareSelector.cshtml
        $(document).on('click', '[data-action="setCompareItem"]', function (event) {
            var $compareItem = $(event.target).closest('[data-action="setCompareItem"]'),
                $checkbox = $compareItem.find('[data-action="updateCheckbox"] input');

            if (!$(event.target).attr('href') && $(event.target).parents('a').length == 0) {
                $checkbox.get(0).checked = !$checkbox.get(0).checked;
                $checkbox.trigger('change');
                event.preventDefault();
                event.stopPropagation();
            }
        });

        $(document).on('change', '[data-action="setCompareItem"] [data-action="updateCheckbox"] input', function (event) {
            var $compareItem = $(event.target).closest('[data-action="setCompareItem"]'),
                checkedCount = $compareItem.parent().find('[data-action="updateCheckbox"] input:checked').length;
            if (checkedCount > 3 && this.checked) {
                this.checked = false;
                $(this).trigger('change');
                $compareItem.attr('data-target', '#maxCompareModal');
                $('#maxCompareModal').modal('show', $compareItem.get(0));
                $compareItem.removeAttr('data-target');
            } else {
                if (checkedCount <= 1) {
                    $('.selectCompareBtn').attr('disabled', '');
                } else {
                    $('.selectCompareBtn').removeAttr('disabled');
                }
                if (this.checked) {
                    $compareItem.addClass('selected');
                } else {
                    $compareItem.removeClass('selected');
                }
            }
        });

        // CompareView.cshtml
        $(document).on('click', '[data-action="removeCompareItem"]', function (event) {
            var itemId = $(event.target).attr('data-itemid'),
                $form = $(event.target).closest('form');
            $('input[type="hidden"][name="itemList"][value="' + itemId + '"]').remove();
            $form.submit();
        });

        $(document).on('change', '#markDifferences', function () {
            var $form = $(this).closest('form');
            $form.submit();
        });
    }

    /**
     * Sets or removes fixed-class on compareListHeader
     */
    function checkScroll(headerTop, parentBottom) {
        var $header = $('#compareListHeader'),
            scrollTop = $(window).scrollTop();

        if (headerTop - 40 < scrollTop && scrollTop < parentBottom - 40 && parentBottom > $(window).height()) {
            $header.addClass('fixed').removeClass('unfixed');
            $header.parent().css('padding-top', $header.height());
        } else {
            $header.addClass('unfixed').removeClass('fixed');
            $header.parent().css('padding-top', 0);
        }
    }

    $(document).ready(function () {
        // CompareSelector.cshtml
        var checkedCount = 0;
        /**
         * Update all checked rows and add/remove parent selected-class.
         */
        $('[data-action="setCompareItem"] [data-action="updateCheckbox"] input').each(function () {
            var $parent = $(this).closest('[data-action="setCompareItem"]');
            if (this.checked) {
                checkedCount++;
                $parent.addClass('selected');
            } else {
                $parent.removeClass('selected');
            }
        });

        if (checkedCount > 1) {
            $('.selectCompareBtn').removeAttr('disabled');
        } else {
            $('.selectCompareBtn').attr('disabled', '');
        }

        // CompareView.cshtml
        if ($('#compareListHeader').length > 0) {

            window.history.replaceState({}, '', "/compareselector/" + $('#compareSectionId').val() + "/" + $('#compareItemId').val());

            var offsetTop = $('#compareListHeader').parent().offset().top,
                offsetBottom = offsetTop + $('#compareListHeader').parent().height() - $('.itemHeader').height();

            checkScroll(offsetTop, offsetBottom);

            $(window).on('scroll', function () {
                checkScroll(offsetTop, offsetBottom);
            });

            $(window).on('touchmove', function () {
                checkScroll(offsetTop, offsetBottom);
            });

            $(window).on('resize', function () {
                var $header = $('#compareListHeader');

                offsetTop = $header.parent().offset().top;
                offsetBottom = offsetTop + $header.parent().height() - $header.height();

                checkScroll(offsetTop, offsetBottom);
            });
        }
        attachListeners();
    });
}(jQuery));;
$(document).ready(function () {
    initGrading();
});

function initGrading() {
    // Init search
    if ($('#searchGradingModel')) {
        var searchGradingModel = new NonSearch($('#searchGradingModel'), {
            onItemClick: function (event) {
                let modelId = $(event.currentTarget).attr('data-itemid');
                if (modelId !== undefined && modelId > -1) {
                    $("#searchGradingModel .form-control.searchInput").val($(event.currentTarget).text());
                    $.get("/TradeIn/GradingSimple/" + modelId, function (data) {
                        $("#gradingSimple").html(data);
                        $("#gradingSimple").collapse('show');
                    });
                }
                event.preventDefault();
            },
            contentSearchEnabledOption: false
        });
    }

    if (window.innerWidth >= 768) {
        $(".maxVisibleSuggest").val($(".maxVisibleSuggestDesktop").val());
    }
    else {
        $(".maxVisibleSuggest").val($(".maxVisibleSuggestMobile").val());
    }

    setQuestionNamePadding();
}

$(document).on("click", "#gradingModal .answer", function (event) {
    if (!$(event.currentTarget).hasClass("selected")) {
        $(event.currentTarget).parent().find(".answer.selected").removeClass("selected");
        $(event.currentTarget).addClass("selected")

        if ($(".questionId").length > 0 && $(".questionId").length == $("#gradingModal .answer.selected").length) {
            $("#gradingError").css("visibility", "hidden");
            GetEstimatedPrice();
        }
    }
    event.preventDefault();
    event.stopPropagation();
});


function GetEstimatedPrice() {

    var modelId = $("#modelId").val();
    var answers = [];

    var selectedAnswers = $("#gradingModal .answer.selected");

    $(selectedAnswers).each(function () {
        let answer = {
            QuestionId: $(this).data("questionid"),
            AnswerId: $(this).data("answerid")
        };
        answers.push(answer);
    });

    $.ajax({
        type: 'POST',
        url: '/TradeIn/GetEstimatedPrice',
        data: JSON.stringify({ modelId: modelId, answers: answers }),
        contentType: 'application/json'
    }).done(function (data) {
        if (data.success) {
            $("#estimationRow").removeClass("hidden");
            $("#estimatedPrice").text(data.estimatedPrice);
            $("#estimationDone").val("true");
            $("#gradingError").css("visibility", "hidden");
        }
        else if (data.errorMessage !== undefined && data.errorMessage.length > 0) {
            $("#gradingError").text(data.errorMessage);
            $("#gradingError").css("visibility", "visible");
        }
    }).fail(function () {
        $button.ladda('stop');
    });
}

//refresh of tradein items list from cart
$(document).on("nonCart.TradeInItemAdded nonCart.TradeInItemRemoved", function (e) {
    var placement = $("#tradeinItems").data("placement");

    $.get("/TradeIn/GetGradingItemList", { placement: placement }, function (data) {
        $("#gradingSimple").collapse('hide');
        $("#searchGradingModel .form-control.searchInput").val("");
        $("#tradeinItems").html(data);

        if (data.trim().length > 0) {
            if ($("#tradein-price").length > 0) {
                var totalTradeInPrice = $(data).find("span[data-tradeinprice]").data("tradeinprice");
                var totalPrice = $("#tradein-price").data("totalprice");
                var priceToFormat = parseFloat(totalPrice) - parseFloat(totalTradeInPrice);
                if (priceToFormat < 0) {
                    $("#tradein-price").addClass("hidden");
                    $("#tradein-price-warning").removeClass("hidden");
                }
                else {
                    $.get("/Content/FormatPriceToCulture/" + JSON.stringify(priceToFormat)).done(function (data) {
                        $("#tradein-price span").html(data.formattedPrice);
                        $("#tradein-price").removeClass("hidden");
                        $("#tradeInSearchDescription").removeClass("hidden");
                        $("#tradein-price-warning").addClass("hidden");
                    });
                }

            }
            $("#tradeInAddToCart").removeClass("hidden");
            $("#addMore").removeClass("hidden");
            $("#gradingSearch").addClass("hidden");
            $("#tradeinItems .howToLink").removeClass("hidden");
            $("#gradingSearch .howToLink").addClass("hidden");
            if (e.namespace === "TradeInItemAdded") {
                $("#gradingItemsList .panel.last").addClass("fading");
            }
        }
        else {
            $("#tradeInSearchDescription").addClass("hidden");
            $("#tradein-price").addClass("hidden");
            $("#tradeInAddToCart").addClass("hidden");
            $("#addMore").addClass("hidden");
            $("#gradingSearch").removeClass("hidden");
            $("#tradeinItems .howToLink").addClass("hidden");
            $("#gradingSearch .howToLink").removeClass("hidden");

            $("#gradingSearch").find(".searchInputClear").each(function () {
                this.click();
            });
        }

    });
});

$(document).on("click", "button[data-action='AddMoreTradeIns']", function () {
    $("#gradingSearch").removeClass("hidden");
    $("#addMore").addClass("hidden");

    $("#gradingSearch").find(".searchInputClear").each(function () {
        this.click();
    });
});

$(document).on("click", "button[data-action='ConfirmTradeIns']", function () {

    $.post("/TradeIn/ConfirmTradeIns", function (data) {
        if (data.success) {
            $("#tradeinItems").empty();
            nonFlash.showSuccess(data.message);
            $(".cartItemCountValue").text(data.itemCount);
            $("#gradingSearch").removeClass("hidden");
            $("#addMore").addClass("hidden");
            $("#tradeInAddToCart").addClass("hidden");
            toggleCartButtons(true);
        }
        else {
            nonFlash.showError(data.message);
        }
    });
});

$(window).on('resize', function () {
    if (window.innerWidth >= 768) {
        $(".maxVisibleSuggest").val($(".maxVisibleSuggestDesktop").val());
    }
    else {
        $(".maxVisibleSuggest").val($(".maxVisibleSuggestMobile").val());
    }
    setQuestionNamePadding();
});

function setQuestionNamePadding() {
    $(".questionName").each(function () {
        if ($(this).height() > 35) {
            $(this).css('padding-top', '0');
        }
        else {
            $(this).css('padding-top', '');
        }
    });
}

function changeActiveTab(e) {
    self = e;
    $(e.closest('#tradeInInfoTabs')).find('a').each(function () {
        $(this).removeClass("active");
        if (self == this) {
            $(this).addClass("active");
        }
    });
};
